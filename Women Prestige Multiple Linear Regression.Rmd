---
title: "Multiple Linear Regression"
author: "JP"
date: "6/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(readr)
df <- read_csv("Women_Prestige_Data.csv")
head(df)
```

```{r}
# Checking data type:
str(df)
```
```{r}
# Data distribution:
library(purrr)
library(tidyr)
library(ggplot2)
par(mfrow= c(3, 3))
df %>%
  keep(is.numeric) %>% subset(select=-c(census))%>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram(aes(y = ..count..), bins=12, fill = "grey") +
    stat_function(fun = dnorm)
    
```

## Including Plots

You can also embed plots, for example:

```{r}
# Graphs to check data distribution:
# Create a function that helps create graphs:
histDenNorm <- function (x, main = "") {
   hist(x, prob = TRUE, main = main) # Histogram
   lines(density(x), col = "blue", lwd = 2) # Density 
   x2 <- seq(min(x), max(x), length = 40)
   f <- dnorm(x2, mean(x), sd(x))
   lines(x2, f, col = "red", lwd = 2) # Normal
   legend("topright", c("Density", "Normal"), box.lty = 3,
          lty = 3, col = c("blue", "red"), lwd = c(1, 2, 2))
}
png(file="images/R graphs.png",
width=600, height=350)
x <- df$education
y <- df$income
z <- df$women
v <- df$prestige
par(mfrow= c(2,2))
histDenNorm(x, main = "education")
histDenNorm(y, main = "income")
histDenNorm(z, main = "women")
histDenNorm(v, main = "prestige")
dev.off()
```
```{r}
# Correlation heatmap:
library(psych)
png(file="images/R heatmap.png",
width=600, height=350)
df1 <- subset(df, select=-c(census, occupation_name, type))
corPlot(df1, cex = 1.2, numbers=TRUE,stars=TRUE)
dev.off()
```
```{r}
library(cowplot)
library(ggplot2)
plot_income <- ggplot(data = df, aes(x = prestige, y = income, col = type)) + geom_point() + geom_smooth(method='lm')
plot_education <- ggplot(data = df, aes(x = prestige, y = education, col = type)) + geom_point() + geom_smooth(method='lm')
plot_women <- ggplot(data = df, aes(x = prestige, y = women, col = type)) + geom_point() + geom_smooth(method='lm')
plot_census <- ggplot(data = df, aes(x = prestige, y = census, col = type)) + geom_point() + geom_smooth(method='lm')
plot_grid(plot_income, plot_education, plot_women, plot_census, labels = "AUTO")

```
```{r}
library(cowplot)
library(ggplot2)
plot_income <- ggplot(data = df, aes(x = prestige, y = income)) + geom_point() + geom_smooth(method='lm')
plot_education <- ggplot(data = df, aes(x = prestige, y = education)) + geom_point() + geom_smooth(method='lm')
plot_women <- ggplot(data = df, aes(x = prestige, y = women)) + geom_point() + geom_smooth(method='lm')
plot_census <- ggplot(data = df, aes(x = prestige, y = census)) + geom_point() + geom_smooth(method='lm')
plot_grid(plot_income, plot_education, plot_women, plot_census, labels = "AUTO")
```
```{r}
########################################
# Correlation heatmap:                 #
########################################
library(psych)

df1 <- subset(df, select=-c(census, occupation_name, type))
corPlot(df1, cex = 1.2, numbers=TRUE,stars=TRUE)
```
```{r}
########################################
# Simple Linear Regression: Predict    #
# Prestige with Education              #
########################################

model <- lm(prestige ~ education, data = df1)
summary(model)

```
```{r}
########################################
# diagnostic plots: Model                   #
########################################

layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(model)
```
```{r}

########################################
# Transform education to center the     #
# values to its mean                   #
########################################

# Center `education` on its mean
education_centered <-  scale(df1$education, center = TRUE, scale = FALSE)
# Modeling
model1 <- lm(prestige ~ education_centered, data = df1)
summary(model1)
```
```{r}
################################################################
# Checking the modal fit: 1. Plotting the fitted               #
################################################################
ggplot(df1, aes(x = education_centered, y = prestige)) +
  geom_point() + 
  stat_smooth(method = "lm", col = "indianred") + 
  scale_y_continuous(breaks = seq(1000, 25000, by = 2000), minor_breaks = NULL)


```
```{r}

################################################################
# Checking the model fit: 2. Plotting the fitted vs residuals  #
################################################################

plot(model1, which = 1, pch = 16)

```
```{r}
########################################
# diagnostic plots: Model1                    #
########################################

layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(model1)


```
```{r}
########################################
# Multiple linear regression           #
########################################

# Center all predictors on their means

education_centered  = scale(df1$education, center = TRUE, scale = FALSE)
income_centered  = scale(df1$income, center = TRUE, scale = FALSE)
women_centered  = scale(df1$women, center = TRUE, scale = FALSE)

# Bind the new variables into a dataframe

centered_predictors <- cbind(education_centered , income_centered , women_centered )
df2 <- cbind(df1, centered_predictors)
names(df2)[5:7] = c("education_centered", "income_centered", "women_centered")
summary(df2)


```
```{r}
# Fit a linear model and run a summary of its results

model2 <- lm(prestige ~ education_centered + income_centered + women_centered, data = df2)
summary(model2)

model3 <- lm(prestige ~ education_centered + income_centered, data = df2)
summary(model3)

```
```{r}
#################################################################
# Comparing the models using ANOVA: Not significantly different #
#################################################################
anova(model1, model2, model3, test=c("Chisq"))

```
```{r}
###############################################################
# Comparing Models Using AIC                                  #
###############################################################

library(AICcmodavg)

model.set <- list(model1, model2, model3)
model.names <- c("model1", "model2", "model3")

aictab(model.set, modnames = model.names)

```
```{r}
########################################
# Model Visualization                  #
########################################
library(tidyverse)
library(plotly)
library(moderndive)

# Define 3D scatterplot points --------------------------------------------
# Get coordinates of points for 3D scatterplot
x_values <- df2$education_centered
y_values <- df2$income_centered
z_values <- df2$prestige

# Define regression plane -------------------------------------------------
# Construct x and y grid elements
x_grid <- seq(from = min(x_values), to = max(x_values), length = 30)
y_grid <- seq(from = min(y_values), to = max(y_values), length = 50)

# Construct z grid by computing
# 1) fitted beta coefficients
# 2) fitted values of outer product of x_grid and y_grid
# 3) extracting z_grid (matrix needs to be of specific dimensions)
beta_hat <- df2 %>% 
  lm(prestige ~ education_centered + income_centered, data = .) %>% 
  coef()
fitted_values <- crossing(y_grid, x_grid) %>%
  mutate(z_grid = beta_hat[1] + beta_hat[2]*x_grid + beta_hat[3]*y_grid)

z_grid <- fitted_values %>% 
  pull(z_grid) %>%
  matrix(nrow = length(x_grid)) %>%
  t()

# Define text element for each point in plane
text_grid <- fitted_values %>% 
  pull(z_grid) %>%
  as.character() %>% 
  paste("prestige: ", ., sep = "") %>% 
  matrix(nrow = length(x_grid)) %>%
  t()

# Plot using plotly -------------------------------------------------------
plot_ly() %>%
  # 3D scatterplot:
  add_markers(
    x = x_values,
    y = y_values,
    z = z_values,
    marker = list(size = 5),
    hoverinfo = 'text',
    text = ~paste(
      "prestige: ", z_values, "<br>",
      "income_centered: ", y_values, "<br>",
      "education_centered: ", x_values 
    )
  ) %>%
  # Regression plane:
  add_surface(
    x = x_grid,
    y = y_grid,
    z = z_grid,
    hoverinfo = 'text',
    text = text_grid
  ) %>%
  # Axes labels and title:
  layout(
    title = "3D scatterplot and regression plane",
    scene = list(
      zaxis = list(title = "y: prestige"),
      yaxis = list(title = "x2: income_centered"),
      xaxis = list(title = "x1: education_centered")
    )
  )
```
```{r}
########################################
# Model Visualization                  #
########################################
library(tidyverse)
library(plotly)
library(moderndive)

# Define 3D scatterplot points --------------------------------------------
# Get coordinates of points for 3D scatterplot
x_values <- df2$income_centered
y_values <- df2$education_centered
z_values <- df2$prestige

# Define regression plane -------------------------------------------------
# Construct x and y grid elements
x_grid <- seq(from = min(x_values), to = max(x_values), length = 30)
y_grid <- seq(from = min(y_values), to = max(y_values), length = 50)

# Construct z grid by computing
# 1) fitted beta coefficients
# 2) fitted values of outer product of x_grid and y_grid
# 3) extracting z_grid (matrix needs to be of specific dimensions)
beta_hat <- df2 %>% 
  lm(prestige ~ income_centered + education_centered, data = .) %>% 
  coef()
fitted_values <- crossing(y_grid, x_grid) %>%
  mutate(z_grid = beta_hat[1] + beta_hat[2]*x_grid + beta_hat[3]*y_grid)

z_grid <- fitted_values %>% 
  pull(z_grid) %>%
  matrix(nrow = length(x_grid)) %>%
  t()

# Define text element for each point in plane
text_grid <- fitted_values %>% 
  pull(z_grid) %>%
  as.character() %>% 
  paste("prestige: ", ., sep = "") %>% 
  matrix(nrow = length(x_grid)) %>%
  t()

# Plot using plotly -------------------------------------------------------
plot_ly() %>%
  # 3D scatterplot:
  add_markers(
    x = x_values,
    y = y_values,
    z = z_values,
    marker = list(size = 5),
    hoverinfo = 'text',
    text = ~paste(
      "prestige: ", z_values, "<br>",
      "income_centered: ", y_values, "<br>",
      "education_centered: ", x_values 
    )
  ) %>%
  # Regression plane:
  add_surface(
    x = x_grid,
    y = y_grid,
    z = z_grid,
    hoverinfo = 'text',
    text = text_grid
  ) %>%
  # Axes labels and title:
  layout(
    title = "3D scatterplot and regression plane",
    scene = list(
      zaxis = list(title = "Prestige"),
      yaxis = list(title = "Education"),
      xaxis = list(title = "Income")
    )
  )

```

```{r}
# diagnostic plots
png(file="images/R diagnostic plots.png",
width=600, height=350)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(model3)
dev.off()
```
```{r}
library("plot3D")
library("misc3d")

# set the x, y, z, and v variables
x <- df$education
y <- df$income
z <- df$prestige
v <- df$women

fit1 <- lm(z ~ x + y)
fit2 <- lm(z ~ x + v)
fit3 <- lm(z ~ y + v)
```

```{r}
library(rockchalk)

model3 = lm(prestige ~ education + income, data=df)

old.par = par(mfrow=c(2,2), mar=c(1,1,1,1))

plotPlane(model3, "education", "income", pch=16, col=rgb(0,0,1,0.1), drawArrows=TRUE, alength=0, 
          acol="red", alty=1,alwd=1, theta=25, phi=0)
plotPlane(model3, "education", "income", pch=16, col=rgb(0,0,1,0.1), drawArrows=TRUE, alength=0, 
          acol="red", alty=1,alwd=1, theta=35, phi=20)

```
```{r}
library(rgl)
library(car)
par(mfrow= c(3, 3))
scatter3d(x=df$education, y=df$prestige, z=df$income,
          box=TRUE,pch=16,bty="b2",axes=TRUE,label=TRUE, nticks=5, ticktype="detailed",theta=40, phi=40, surface = TRUE, xlab="Education", ylab="Prestige", zlab="Income", main="3D scatter plot", ellipsoid=TRUE, revolutions=3)

#scatter3d(x=df$education, y=df$prestige, z=df$women,
#          box=TRUE,pch=16,bty="b2",axes=TRUE,label=TRUE, nticks=5, #ticktype="detailed",theta=40, phi=40, xlab="Education", #ylab="Prestige", zlab="Women", main="3D scatter plot")
```
```{R}
scatter3d(df$prestige , df$income,  df$education, id=TRUE, surface=TRUE, model.summary = TRUE, ellipsoid=TRUE, revolutions=3)

```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
